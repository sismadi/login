<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>myapp Â· Login GitHub (SPA + PKCE)</title>
  <style>
    body{margin:0;background:#0b1220;color:#e7efff;font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:960px;margin:20px auto;padding:0 16px}
    .card{background:#111a2f;border:1px solid #1b2b48;border-radius:14px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1b2b48}
    .row:last-child{border-bottom:0}
    .btn{padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.primary{background:#17375e;color:#fff;border:1px solid #2a4d7f}
    .btn.danger{background:#4a2230;color:#fff;border:1px solid #6a2f44}
    .pill{padding:2px 8px;border-radius:999px;background:#0d1a30;border:1px solid #1b2b48}
    .ok{color:#3fb950}.err{color:#ff6b6b}.muted{color:#9bb0d0}
    .avatar{width:56px;height:56px;border-radius:50%}
    .list{padding:8px 16px}
    .repo{padding:10px 0;border-bottom:1px dashed #29405f}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>myapp <span class="muted">Â· GitHub Login</span></h1>

    <div class="card">
      <div class="row">
        <div>
          <div><strong>Status:</strong> <span id="status" class="pill muted">belum login</span></div>
        </div>
        <div id="actions">
          <button id="loginBtn" class="btn primary">Login dengan GitHub</button>
        </div>
      </div>

      <div class="row" id="whoami" hidden>
        <div style="display:flex;gap:12px;align-items:center">
          <img id="avatar" class="avatar" alt="">
          <div>
            <div id="name"></div>
            <div id="login" class="muted"></div>
          </div>
        </div>
        <div>
          <button id="logoutBtn" class="btn danger">Logout</button>
        </div>
      </div>

      <div class="row"><strong>Token:</strong> <span id="tokenBox" class="muted">â€“</span></div>
      <div class="list" id="repos"><span class="muted">Repositori belum dimuat</span></div>
    </div>
  </div>

<script>
const CLIENT_ID = "Ov23lis3fqdO2Kv7zyvI";
const REDIRECT_URI = "https://sismadi.github.io/login/";
const SCOPES = ["read:user","user:email"];
const TOKEN_PROXY = "https://myapp.wawan.workers.dev/token";

// util
const b64url = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
const sha256 = async str => await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
const randStr = (len=64)=>Array.from(crypto.getRandomValues(new Uint8Array(len))).map(b=>("0"+b.toString(16)).slice(-2)).join("");

// ui
const ui = {
  status:document.getElementById("status"),
  loginBtn:document.getElementById("loginBtn"),
  logoutBtn:document.getElementById("logoutBtn"),
  actions:document.getElementById("actions"),
  whoami:document.getElementById("whoami"),
  avatar:document.getElementById("avatar"),
  name:document.getElementById("name"),
  login:document.getElementById("login"),
  tokenBox:document.getElementById("tokenBox"),
  repos:document.getElementById("repos")
};
const setStatus=(txt,cls="muted")=>{ui.status.textContent=txt;ui.status.className="pill "+cls};

// flow
async function beginLogin(){
  const state=randStr(24);
  const verifier=randStr(64);
  const challenge=b64url(await sha256(verifier));
  sessionStorage.setItem("gh_state",state);
  sessionStorage.setItem("gh_verifier",verifier);

  const url=new URL("https://github.com/login/oauth/authorize");
  url.searchParams.set("client_id",CLIENT_ID);
  url.searchParams.set("redirect_uri",REDIRECT_URI);
  url.searchParams.set("scope",SCOPES.join(" "));
  url.searchParams.set("state",state);
  url.searchParams.set("code_challenge",challenge);
  url.searchParams.set("code_challenge_method","S256");
  window.location=url.toString();
}

async function exchangeCodeForToken(code,stateFromUrl){
  const state=sessionStorage.getItem("gh_state");
  const verifier=sessionStorage.getItem("gh_verifier");
  if(!state||!verifier||state!==stateFromUrl){
    throw new Error("State/verifier mismatch");
  }
  const payload={client_id:CLIENT_ID,code,redirect_uri:REDIRECT_URI,code_verifier:verifier};
  const res=await fetch(TOKEN_PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const data=await res.json().catch(()=>({}));
  console.log("Token response:",data); // ðŸ‘ˆ debug
  return data;
}

function storeToken(t){sessionStorage.setItem("gh_token",t);}
function getToken(){return sessionStorage.getItem("gh_token");}
function logout(){sessionStorage.clear();location.href=REDIRECT_URI;}
async function fetchJSON(url,tok){const r=await fetch(url,{headers:{Authorization:"Bearer "+tok}});return await r.json();}

async function loadProfile(tok){
  const me=await fetchJSON("https://api.github.com/user",tok);
  ui.avatar.src=me.avatar_url;
  ui.name.textContent=me.name||"(tanpa nama)";
  ui.login.textContent="@"+me.login;
  ui.tokenBox.textContent=tok.slice(0,10)+"â€¦"+tok.slice(-6);
  setStatus("login","ok");
  ui.whoami.hidden=false;
  const repos=await fetchJSON("https://api.github.com/user/repos?sort=updated&per_page=5",tok);
  ui.repos.innerHTML=repos.map(r=>`<div class="repo"><a target="_blank" href="${r.html_url}">${r.full_name}</a></div>`).join("");
}

// init
(async()=>{
  ui.loginBtn.onclick=beginLogin;
  ui.logoutBtn.onclick=logout;

  const p=new URLSearchParams(location.search);
  const code=p.get("code"), state=p.get("state");
  const token=getToken();

  if(token){
    try{await loadProfile(token);}catch(e){console.error(e);logout();}
    return;
  }
  if(code&&state){
    try{
      setStatus("menukar code â†’ tokenâ€¦");
      const r=await exchangeCodeForToken(code,state);
      if(r.access_token){storeToken(r.access_token);history.replaceState({}, "", REDIRECT_URI);await loadProfile(r.access_token);}
      else throw new Error("Token tidak ditemukan di respons");
    }catch(e){console.error(e);alert(e.message);setStatus("gagal","err");}
  }
})();
</script>
</body>
</html>
